version: 2
jobs:
  build:
    docker:
      - image: circleci/php:7-cli-stretch-node-browsers

    branches:
      only:
        # Whitelist branches to build for.
        - master
        - trunk
    steps:
      # Install required packages
      - run: sudo apt-get install -y gettext
      - run:
          name: Install yarn
          command: |
            sudo apt-get install -y apt-transport-https
            curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
            echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends yarn

      # Checkout repo & subs:
      - checkout

      # Get npm cache:
      - restore_cache:
          key: build

      # Build steps:
      - run: composer install
      - run: yarn
      - run:
          name: Build artifact
          environment:
            SC_ATTR: wordpress-seo
          command: node_modules/.bin/grunt artifact

      # Make fast:
      - save_cache:
          key: build
          paths:
            - ~/.composer
            - ~/.npm
            - ~/.node-gyp
            - ~/.yarn
            - ~/.yarn-cache

      # Run the deploy:
      - deploy:
          environment:
            SRC_PATH: /artifact/
          command: .circleci/deploy.sh
